---
import { siteConfig } from '../../data/site-config';
import { getNewsletterFeed } from '../../lib/newsletter-feed';

const { newsletter } = siteConfig;
const latestArticles = await getNewsletterFeed();
---

<section id="newsletter" class="border-b border-navy-800 py-16 lg:py-24">
  <div class="content-shell">

    <!-- Section eyebrow with expanding rule -->
    <div class="nl-header mb-10 flex items-center gap-5">
      <p class="flex-shrink-0 font-mono text-xs uppercase tracking-[0.25em] text-cyan-400">Newsletter</p>
      <div class="nl-rule h-px flex-1 origin-left scale-x-0 bg-navy-700"></div>
    </div>

    <!-- Two-column layout -->
    <div class="grid gap-10 lg:grid-cols-2 lg:gap-20">

      <!-- Left: Identity + CTA -->
      <div class="nl-left">
        <h2 class="text-3xl font-bold sm:text-4xl">{newsletter.headline} <span class="text-2xl font-bold sm:text-3xl">{newsletter.headlineSuffix}</span></h2>
        <p class="mt-4 text-base leading-relaxed text-slate-300">{newsletter.description}</p>

        <div class="mt-6 flex items-center gap-3">
          <span class="font-mono text-xl font-bold text-cyan-400">{newsletter.subscribersShort}</span>
          <span class="h-1 w-1 rounded-full bg-navy-700"></span>
          <span class="text-sm text-slate-500">{newsletter.socialProof}</span>
        </div>

        <a
          href={newsletter.link}
          target="_blank"
          rel="noopener noreferrer"
          class="btn-primary mt-8 inline-flex"
        >
          {newsletter.ctaText}
        </a>
      </div>

      <!-- Right: Article feed -->
      <div class="nl-right">
        {
          latestArticles.length > 0 ? (
            <>
              <p class="mb-3 font-mono text-xs uppercase tracking-[0.2em] text-slate-500">Latest Issues</p>
              <div class="nl-list-wrapper relative">
                <ul id="nl-article-list" class="nl-list h-[210px] overflow-y-auto">
                  {latestArticles.map((article, i) => (
                    <li class="nl-article" style={`--i: ${i}`}>
                      <a
                        href={article.link}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="group flex items-start justify-between gap-4 border-b border-navy-800 py-3.5"
                      >
                        <span class="text-sm font-medium leading-snug text-slate-300 transition-colors duration-200 group-hover:text-white">
                          {article.title}
                        </span>
                        <span class="mt-0.5 flex-shrink-0 text-xs text-slate-600 transition-all duration-200 group-hover:translate-x-0.5 group-hover:text-cyan-400">
                          ↗
                        </span>
                      </a>
                    </li>
                  ))}
                </ul>
                <div class="nl-scrollbar-track absolute right-0 top-0 h-full w-px rounded-full bg-navy-700">
                  <div id="nl-scrollbar-thumb" class="absolute left-0 w-full rounded-full bg-slate-500/60"></div>
                </div>
              </div>
              <a
                href={newsletter.link}
                target="_blank"
                rel="noopener noreferrer"
                class="mt-5 inline-flex items-center gap-1 font-mono text-xs text-slate-500 transition-colors duration-200 hover:text-cyan-400"
              >
                View all issues →
              </a>
            </>
          ) : (
            <div class="rounded-lg border border-amber-500/20 bg-amber-900/10 p-4">
              <p class="text-sm text-slate-300">Latest posts are temporarily unavailable.</p>
              <a
                href={newsletter.link}
                target="_blank"
                rel="noopener noreferrer"
                class="mt-2 inline-flex items-center text-sm font-semibold text-cyan-400 hover:text-cyan-300"
              >
                Visit the newsletter →
              </a>
            </div>
          )
        }
      </div>

    </div>
  </div>
</section>

<style>
  /* Header: fade in, rule expands */
  .nl-header {
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  .nl-rule {
    transition: transform 0.75s cubic-bezier(0.4, 0, 0.2, 1) 0.15s;
  }
  .nl-header.visible {
    opacity: 1;
  }
  .nl-header.visible .nl-rule {
    transform: scaleX(1);
  }

  /* Left column: slide up */
  .nl-left {
    opacity: 0;
    transform: translateY(14px);
    transition:
      opacity 0.55s ease 0.2s,
      transform 0.55s ease 0.2s;
  }
  .nl-left.visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* Right column: slide up with slight extra delay */
  .nl-right {
    opacity: 0;
    transform: translateY(14px);
    transition:
      opacity 0.55s ease 0.3s,
      transform 0.55s ease 0.3s;
  }
  .nl-right.visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* Scrollable list: hide native scrollbar */
  #nl-article-list {
    scrollbar-width: none; /* Firefox */
  }
  #nl-article-list::-webkit-scrollbar {
    display: none; /* Chrome/Safari/Edge */
  }

  /* Custom scrollbar track + thumb */
  .nl-scrollbar-track {
    pointer-events: none;
  }
  #nl-scrollbar-thumb {
    transition: top 0.1s linear, height 0s;
  }

  /* Articles: stagger slide in from left */
  .nl-article {
    opacity: 0;
    transform: translateX(-8px);
    transition:
      opacity 0.35s ease calc(0.45s + var(--i, 0) * 0.07s),
      transform 0.35s ease calc(0.45s + var(--i, 0) * 0.07s);
  }
  .nl-article.visible {
    opacity: 1;
    transform: translateX(0);
  }
</style>

<script>
  // --- Scrollbar thumb sync ---
  function syncThumb() {
    const list = document.getElementById('nl-article-list');
    const thumb = document.getElementById('nl-scrollbar-thumb');
    if (!list || !thumb) return;
    const ratio = list.clientHeight / list.scrollHeight;
    const thumbH = Math.max(ratio * list.clientHeight, 20);
    const maxTop = list.clientHeight - thumbH;
    const progress = list.scrollTop / (list.scrollHeight - list.clientHeight);
    thumb.style.height = thumbH + 'px';
    thumb.style.top = (progress * maxTop) + 'px';
  }

  // --- Ping-pong engine ---
  const SPEED = 38;      // px/s — slow, mesmerizing
  const PAUSE_MS = 700;  // pause at top/bottom before reversing

  let animId: number | null = null;
  let direction = 1;         // 1 = down, -1 = up
  let pausing = false;
  let userControlled = false;
  let lastTs: number | null = null;

  function autoScroll(ts: number) {
    if (userControlled) return;
    if (pausing) { animId = requestAnimationFrame(autoScroll); return; }

    const list = document.getElementById('nl-article-list');
    if (!list) return;

    if (!lastTs) lastTs = ts;
    const delta = (ts - lastTs) / 1000;
    lastTs = ts;

    list.scrollTop += direction * SPEED * delta;
    syncThumb();

    const maxScroll = list.scrollHeight - list.clientHeight;

    if (direction === 1 && list.scrollTop >= maxScroll - 1) {
      list.scrollTop = maxScroll;
      pausing = true;
      direction = -1;
      setTimeout(() => { pausing = false; }, PAUSE_MS);
    } else if (direction === -1 && list.scrollTop <= 1) {
      list.scrollTop = 0;
      pausing = true;
      direction = 1;
      setTimeout(() => { pausing = false; }, PAUSE_MS);
    }

    animId = requestAnimationFrame(autoScroll);
  }

  function startAutoScroll() {
    if (userControlled) return;
    lastTs = null;
    animId = requestAnimationFrame(autoScroll);
  }

  // --- User control ---
  const listEl = document.getElementById('nl-article-list');
  if (listEl) {
    listEl.addEventListener('mouseenter', () => {
      userControlled = true;
      if (animId) { cancelAnimationFrame(animId); animId = null; }
    });
    listEl.addEventListener('mouseleave', () => {
      userControlled = false;
      startAutoScroll();
    });
    listEl.addEventListener('touchstart', () => {
      userControlled = true;
      if (animId) { cancelAnimationFrame(animId); animId = null; }
    }, { passive: true });
    listEl.addEventListener('touchend', () => {
      setTimeout(() => { userControlled = false; startAutoScroll(); }, 3000);
    }, { passive: true });
    listEl.addEventListener('scroll', syncThumb, { passive: true });
    syncThumb();
  }

  // --- Intersection Observer (entrance animations + auto-scroll trigger) ---
  const section = document.querySelector('#newsletter');
  if (section) {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          section.querySelectorAll('.nl-header, .nl-left, .nl-right').forEach((el) =>
            el.classList.add('visible'),
          );
          section.querySelectorAll('.nl-article').forEach((el) => el.classList.add('visible'));
          setTimeout(startAutoScroll, 1600);
          observer.disconnect();
        }
      },
      { threshold: 0.1 },
    );
    observer.observe(section);
  }
</script>
