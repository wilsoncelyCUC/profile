---
import { siteConfig } from '../../data/site-config';

const { community } = siteConfig;

type CommunityEvent = {
  title?: string;
  date?: string;
  description?: string;
  spotsLeft?: string;
  urgencyText?: string;
  link?: string;
  imageUrl?: string;
};

const LUMA_CALENDAR_URL = 'https://luma.com/munich-mlops';

const cleanText = (value = '') => value.replace(/\s+/g, ' ').trim();

const toAbsoluteUrl = (href?: string) => {
  if (!href) return undefined;
  if (href.startsWith('http://') || href.startsWith('https://')) return href;
  if (href.startsWith('/')) return `https://luma.com${href}`;
  return undefined;
};

const formatDate = (isoDate?: string) => {
  if (!isoDate) return undefined;
  const parsed = new Date(isoDate);
  if (Number.isNaN(parsed.getTime())) return undefined;
  return new Intl.DateTimeFormat('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  }).format(parsed);
};

const extractEventDataFromHtml = (html: string): Partial<CommunityEvent> | null => {
  const titleMatch = html.match(/<h3[^>]*>\s*([^<]+?)\s*<\/h3>/i);
  if (!titleMatch || titleMatch.index === undefined) return null;

  const title = cleanText(titleMatch[1]);
  const titleIndex = titleMatch.index;
  const prefix = html.slice(0, titleIndex);
  const anchorStart = prefix.lastIndexOf('<a');
  const anchorTagEnd = anchorStart >= 0 ? html.indexOf('>', anchorStart) : -1;
  const anchorTag =
    anchorStart >= 0 && anchorTagEnd > anchorStart ? html.slice(anchorStart, anchorTagEnd + 1) : '';

  const hrefMatch = anchorTag.match(/href="([^"]+)"/i);
  const link = toAbsoluteUrl(cleanText(hrefMatch?.[1] || ''));

  const imageMatch = anchorTag.match(/src="([^"]+)"/i);
  const imageUrl = imageMatch ? cleanText(imageMatch[1]) : undefined;

  const dateIsoMatch = html.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?/);
  const date = formatDate(dateIsoMatch?.[0]);

  return {
    title,
    link,
    imageUrl,
    date,
  };
};

const fetchLatestLumaEvent = async (calendarUrl: string): Promise<Partial<CommunityEvent> | null> => {
  try {
    const calendarRes = await fetch(calendarUrl, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (compatible; WilsonCelySiteBot/1.0)',
      },
    });
    if (!calendarRes.ok) return null;

    const calendarHtml = await calendarRes.text();
    const eventFromCalendar = extractEventDataFromHtml(calendarHtml);
    if (!eventFromCalendar?.link) return eventFromCalendar;

    const eventRes = await fetch(eventFromCalendar.link, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (compatible; WilsonCelySiteBot/1.0)',
      },
    });
    if (!eventRes.ok) return eventFromCalendar;

    const eventHtml = await eventRes.text();
    const firstIso = eventHtml.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?/);
    const eventDate = formatDate(firstIso?.[0]);

    return {
      ...eventFromCalendar,
      date: eventDate || eventFromCalendar.date,
    };
  } catch {
    return null;
  }
};

const fallbackEvent: CommunityEvent = {
  ...community?.event,
  link: community?.event?.link || community?.link || LUMA_CALENDAR_URL,
};

const lumaEvent = await fetchLatestLumaEvent(community?.link || LUMA_CALENDAR_URL);
const featuredEvent: CommunityEvent = {
  ...fallbackEvent,
  ...lumaEvent,
};
---

<section id="community" class="py-24 bg-bg-light">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Section Header -->
    <div class="mb-12 text-center">
      <span class="inline-block px-4 py-1.5 bg-primary/10 text-primary rounded-full text-sm font-mono tracking-wide mb-4">
        COMMUNITY
      </span>
      <h2 class="text-3xl sm:text-4xl font-black text-text-dark mb-4">
        {community?.headline || "Building Munich's MLOps Scene"}
      </h2>
      <p class="text-xl text-text-dark/70 max-w-2xl mx-auto">
        {community?.description || "Co-organizer of Europe's largest MLOps community."}
        <span class="font-bold text-primary"> {community?.membersShort || "40K+"}</span> practitioners sharing real production wins.
      </p>
    </div>

    <!-- Cards Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">

      <!-- Next Event Card -->
      <div class="glass-event-card rounded-2xl p-6 lg:p-8 relative overflow-hidden flex flex-col">
        <!-- Urgency Pill -->
        <div class="absolute top-4 right-4">
          <span class="pulse-pill inline-flex items-center gap-1.5 px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium border border-amber-200">
            <span class="w-1.5 h-1.5 bg-amber-500 rounded-full animate-pulse"></span>
            {community?.event?.urgencyText || "Seats Filling Fast"}
          </span>
        </div>

        <div class="flex items-center gap-3 mb-4">
          {
            featuredEvent?.imageUrl ? (
              <img
                src={featuredEvent.imageUrl}
                alt={featuredEvent.title || 'Munich MLOps event cover'}
                class="w-10 h-10 rounded-lg object-cover border border-primary/20"
                loading="lazy"
              />
            ) : (
              <div class="w-10 h-10 rounded-lg bg-white/80 flex items-center justify-center">
                <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
              </div>
            )
          }
          <div>
            <span class="text-xs font-semibold text-primary/70 uppercase tracking-wide">Next Event</span>
            <h3 class="text-lg font-bold text-text-dark">
              {featuredEvent?.title || "Munich MLOps Meetup #21"}
            </h3>
          </div>
        </div>

        <p class="text-sm font-mono font-semibold text-primary mb-2">
          {featuredEvent?.date || "Jan 28, 2026"}
        </p>

        <p class="text-text-dark/80 mb-6 flex-grow">
          {featuredEvent?.description || "Gen AI at Scale: From Lambda Struggles to Bedrock Agents"}
        </p>

        <div class="flex items-center justify-between">
          <span class="text-sm text-text-dark/60 font-medium">{featuredEvent?.spotsLeft || "4 spots left"}</span>
          <a
            href={featuredEvent?.link || "#"}
            target="_blank"
            rel="noopener noreferrer"
            class="magnetic-btn inline-flex items-center gap-2 px-5 py-2.5 bg-primary text-white font-semibold rounded-xl hover:bg-primary/90 transition-all group"
          >
            <span>RSVP</span>
            <svg class="w-4 h-4 transition-transform duration-300 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
            </svg>
          </a>
        </div>
      </div>

      <!-- Become a Sponsor Card -->
      <div class="bg-white rounded-2xl p-6 lg:p-8 border border-primary-light/50 shadow-sm hover:shadow-md hover:border-primary/30 transition-all flex flex-col">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-lg bg-primary-light flex items-center justify-center">
            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
            </svg>
          </div>
          <div>
            <span class="text-xs font-semibold text-primary/70 uppercase tracking-wide">Partnership</span>
            <h3 class="text-lg font-bold text-text-dark">
              {community?.sponsor?.title || "Become a Sponsor"}
            </h3>
          </div>
        </div>

        <p class="text-text-dark/80 mb-6 flex-grow">
          {community?.sponsor?.description || `Get in front of ${community?.membersShort || "40K+"} ML practitioners. Showcase your tools, hire top talent, or host an event.`}
        </p>

        <div class="flex items-center gap-4">
          <a
            href={community?.sponsor?.link || community?.contactLink || "#contact"}
            class="inline-flex items-center gap-2 text-primary hover:text-primary/80 transition-colors font-semibold group"
          >
            <span>{community?.sponsor?.cta || "Get in touch"}</span>
            <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
            </svg>
          </a>
        </div>
      </div>

    </div>

    <!-- Community Link -->
    <div class="mt-10 text-center">
      <a
        href={community?.link || "#"}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center gap-2 text-text-dark/60 hover:text-primary transition-colors text-sm font-medium group"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
        <span>Join the Munich MLOps Community</span>
        <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
        </svg>
      </a>
    </div>
  </div>
</section>

<style>
  /* Pulse Pill Animation */
  .pulse-pill {
    animation: pulse-glow 2s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% {
      box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.3);
    }
    50% {
      box-shadow: 0 0 0 6px rgba(245, 158, 11, 0);
    }
  }

  /* Glassmorphism Event Card */
  .glass-event-card {
    background: linear-gradient(135deg, rgba(43, 168, 163, 0.08) 0%, rgba(179, 233, 230, 0.25) 100%);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(43, 168, 163, 0.25);
    box-shadow: 0 8px 32px rgba(43, 168, 163, 0.1);
    transition: all 0.3s ease;
  }

  .glass-event-card:hover {
    border-color: rgba(43, 168, 163, 0.4);
    box-shadow: 0 12px 40px rgba(43, 168, 163, 0.15);
    transform: translateY(-2px);
  }

  /* Magnetic Button Enhancement */
  .magnetic-btn {
    position: relative;
    overflow: hidden;
  }

  .magnetic-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transform: translateX(-100%);
    transition: transform 0.5s ease;
  }

  .magnetic-btn:hover::before {
    transform: translateX(100%);
  }
</style>
